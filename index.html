<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é™è»Šã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆéŸ³ï¼‹æŒ¯å‹•ï¼‰</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; }
  h1 { font-size: 1.4rem; }
  label { display: block; margin-top: 12px; }
  button { margin-top: 16px; padding: 12px 20px; font-size: 1rem; }
  select, input { padding: 8px; font-size: 1rem; width: 100%; max-width: 360px; }
  #status { margin-top: 16px; font-weight: bold; }
</style>
</head>
<body>

<h1>ğŸš‰ é™è»Šã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆéŸ³ï¼‹æŒ¯å‹•ï¼‰</h1>
<p>é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€é§…ã«è¿‘ã¥ã„ãŸã¨ã<strong>éŸ³ã¨æŒ¯å‹•</strong>ã§é€šçŸ¥ã—ã¾ã™ã€‚</p>

<label>
  é§…ã‚’é¸æŠ:
  <select id="stationSelect">
    <option value="">é§…ã‚’é¸æŠ</option>
    <option value="35.681236,139.767125">æ±äº¬é§…</option>
    <option value="35.689592,139.700413">æ–°å®¿é§…</option>
    <option value="35.658034,139.701636">æ¸‹è°·é§…</option>
    <option value="35.712056,139.773021">ä¸Šé‡é§…</option>
    <option value="35.728926,139.71038">æ± è¢‹é§…</option>
    <option value="35.642131,139.668556">ä¸‰è»’èŒ¶å±‹é§…</option>
  </select>
</label>

<label>
  åˆ°ç€é€šçŸ¥è·é›¢ï¼ˆmï¼‰:
  <input type="number" id="distance" value="300" min="50" max="2000" />
</label>

<button id="startBtn">â–¶ é–‹å§‹ï¼ˆéŸ³ONï¼‰</button>
<button id="stopBtn">â–  åœæ­¢</button>

<p id="status">å¾…æ©Ÿä¸­</p>

<!-- éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆindex.html ã¨åŒã˜å ´æ‰€ã« alarm.mp3 ã‚’ç½®ãï¼‰ -->
<audio id="alarmSound" preload="auto">
  <source src="alarm.mp3" type="audio/mpeg" />
</audio>

<script>
let watchId = null;

function updateStatus(text) {
  document.getElementById('status').innerText = text;
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function vibrateAlarm() {
  if (navigator.vibrate) {
    navigator.vibrate([300, 200, 300]);
  }
}

function playAlarm() {
  const audio = document.getElementById('alarmSound');
  if (!audio) return;
  audio.currentTime = 0;
  audio.play().catch(() => {});
}

// é–‹å§‹

document.getElementById('startBtn').onclick = () => {
  if (!navigator.geolocation) {
    alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“');
    return;
  }

  const stationVal = document.getElementById('stationSelect').value;
  if (!stationVal) {
    alert('é§…ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  // â˜… ã“ã“ã§ä¸€åº¦éŸ³ã‚’é³´ã‚‰ã—ã¦ã€ŒéŸ³ã®ä½¿ç”¨è¨±å¯ã€ã‚’å–ã‚‹
  playAlarm();

  const [lat, lng] = stationVal.split(',').map(Number);
  const limit = Number(document.getElementById('distance').value) || 300;

  updateStatus('æ¸¬ä½ä¸­â€¦');

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const d = calcDistance(
        pos.coords.latitude,
        pos.coords.longitude,
        lat,
        lng
      );

      updateStatus(`ç¾åœ¨åœ°ã¨ã®è·é›¢: ${d.toFixed(0)} m`);

      // 300ã€œ1000m ã®é–“ã¯é³´ã‚Šç¶šã‘ã‚‹
      if (d > 300 && d < 1000) {
        vibrateAlarm();
        playAlarm();
      }

      // åˆ°ç€
      if (d <= limit) {
        vibrateAlarm();
        playAlarm();
        alert('ç›®çš„åœ°ä»˜è¿‘ã«åˆ°ç€ã—ã¾ã—ãŸï¼');
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        updateStatus('åˆ°ç€ã—ã¾ã—ãŸ');
      }
    },
    err => {
      alert('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“');
      updateStatus('ã‚¨ãƒ©ãƒ¼');
      console.error(err);
    },
    { enableHighAccuracy: true }
  );
};

// åœæ­¢

document.getElementById('stopBtn').onclick = () => {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  updateStatus('åœæ­¢ã—ã¾ã—ãŸ');
};
</script>

</body>
</html>
