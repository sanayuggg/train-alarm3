<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é™è»Šã‚¢ãƒ©ãƒ¼ãƒ </title>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; }
  h1 { font-size: 1.6rem; }
  select, input, button { font-size: 1rem; padding: 8px; margin-top: 10px; }
  button { width: 80%; max-width: 300px; border-radius: 10px; }
  #status { margin-top: 15px; font-weight: bold; }
  #stationStatus { margin-top: 10px; font-size: 1.1rem; }
</style>
</head>
<body>

<h1>ğŸšƒ é™è»Šã‚¢ãƒ©ãƒ¼ãƒ </h1>
<p>é§…ã‚’é¸ã‚“ã§ã€Œé–‹å§‹ã€ã‚’æŠ¼ã™ã ã‘</p>

<select id="stationSelect">
  <option value="">é§…ã‚’é¸æŠ</option>
  <option value="35.681236,139.767125">æ±äº¬é§…</option>
  <option value="35.689592,139.700413">æ–°å®¿é§…</option>
  <option value="35.658034,139.701636">æ¸‹è°·é§…</option>
  <option value="35.642131,139.668556">ä¸‰è»’èŒ¶å±‹é§…</option>
</select>

<br />

<label>
  é€šçŸ¥è·é›¢ï¼ˆmï¼‰<br />
  <input type="number" id="distance" value="300" min="100" max="1000" />
</label>

<br />

<button id="startBtn">â–¶ é–‹å§‹</button><br />
<button id="stopBtn">â–  åœæ­¢</button>

<p id="stationStatus"></p>
<p id="status"></p>

<audio id="alarm" src="Clock-Alarm05-1(Mid).mp3" loop></audio>

<script>
let watchId = null;
const alarm = document.getElementById("alarm");

function updateStatus(text) {
  document.getElementById("status").innerText = text;
}

function updateStation(text) {
  document.getElementById("stationStatus").innerText = text;
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function notify() {
  alarm.play().catch(()=>{});
  if (navigator.vibrate) navigator.vibrate([500,300,500]);
}

startBtn.onclick = () => {
  if (!navigator.geolocation) {
    alert("ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“");
    return;
  }

  const selectEl = document.getElementById("stationSelect");
  const stationVal = selectEl.value;
  if (!stationVal) {
    alert("é§…ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const stationName = selectEl.options[selectEl.selectedIndex].text;
  updateStation(`ç›®çš„åœ°ï¼š${stationName}`);

  const [lat, lng] = stationVal.split(',').map(Number);
  const limit = Number(document.getElementById("distance").value) || 300;

  updateStatus("ä½ç½®æƒ…å ±å–å¾—ä¸­â€¦");

  if (watchId !== null) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(pos => {
    const d = calcDistance(pos.coords.latitude, pos.coords.longitude, lat, lng);
    updateStatus(`æ®‹ã‚Š ${Math.round(d)} m`);

    if (d <= limit) {
      notify();
      alert(`${stationName} ã«åˆ°ç€ï¼`);
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      updateStatus("åˆ°ç€ã—ã¾ã—ãŸ");
    }
  }, err => {
    alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“");
  }, { enableHighAccuracy: true });
};

stopBtn.onclick = () => {
  if (watchId !== null) navigator.geolocation.clearWatch(watchId);
  watchId = null;
  alarm.pause();
  alarm.currentTime = 0;
  updateStatus("åœæ­¢ã—ã¾ã—ãŸ");
};
</script>

</body>
</html>
